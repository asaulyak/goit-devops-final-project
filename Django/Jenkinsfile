pipeline {
    agent {
        kubernetes {
            yaml """
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins-kaniko
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:latest
    command:
    - /busybox/sh
    - -c
    - sleep 3600
    volumeMounts:
    - name: docker-config
      mountPath: /kaniko/.docker
    env:
    - name: AWS_REGION
      value: "us-east-2"
    - name: AWS_DEFAULT_REGION
      value: "us-east-2"
  volumes:
  - name: docker-config
    configMap:
      name: docker-config
"""
        }
    }
    
    environment {
        ECR_REPOSITORY_URL = ''  # Will be set from ECR repository URL
        AWS_REGION = 'us-east-2'
        GIT_REPO_URL = "${env.JENKINS_GIT_REPOSITORY_URL ?: 'https://github.com/asaulyak/goit-devops.git'}"
        GIT_BRANCH = "${env.JENKINS_GIT_BRANCH ?: 'main'}"
        HELM_CHART_PATH = 'charts/django-app'
        DOCKERFILE_PATH = 'Dockerfile'
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    try {
                        checkout scm
                    } catch (Exception e) {
                        echo "SCM checkout failed, cloning repository..."
                        sh """
                            if [ ! -d .git ]; then
                                git clone ${GIT_REPO_URL} .
                            else
                                git pull origin ${GIT_BRANCH}
                            fi
                        """
                    }
                }
            }
        }
        
        stage('Build and Push to ECR') {
            steps {
                container('kaniko') {
                    script {
                        def imageTag = "${ECR_REPOSITORY_URL}:${BUILD_NUMBER}"
                        def imageTagLatest = "${ECR_REPOSITORY_URL}:latest"
                        
                        echo "Building Docker image..."
                        echo "Image tag: ${imageTag}"
                        
                        sh """
                            cd Django
                            /kaniko/executor \
                              --context . \
                              --dockerfile ${DOCKERFILE_PATH} \
                              --destination ${imageTag} \
                              --destination ${imageTagLatest} \
                              --cache=true \
                              --cache-ttl=24h \
                              --verbosity=info
                        """
                        
                        echo "Successfully pushed ${imageTag} and ${imageTagLatest} to ECR"
                    }
                }
            }
        }
        
        stage('Update values.yaml') {
            steps {
                script {
                    echo "Updating Helm chart values.yaml with new image tag..."
                    
                    sh """
                        git config user.name "Jenkins CI"
                        git config user.email "jenkins@goit-devops.local"
                        
                        sed -i 's|repository:.*|repository: ${ECR_REPOSITORY_URL}|g' ${HELM_CHART_PATH}/values.yaml
                        sed -i 's|tag:.*|tag: ${BUILD_NUMBER}|g' ${HELM_CHART_PATH}/values.yaml
                        
                        echo "Updated values.yaml:"
                        grep -E "(repository|tag):" ${HELM_CHART_PATH}/values.yaml || true
                    """
                }
            }
        }
        
        stage('Commit and Push to Git') {
            steps {
                script {
                    echo "Committing and pushing changes to Git repository..."
                    
                    try {
                        withCredentials([usernamePassword(credentialsId: 'github-credentials', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')]) {
                            sh """
                                git config user.name "Jenkins CI"
                                git config user.email "jenkins@goit-devops.local"
                                def repoUrl = "${GIT_REPO_URL}".replaceAll('^https?://', '')
                                git remote set-url origin https://${GIT_USER}:${GIT_TOKEN}@${repoUrl}
                                
                                git add ${HELM_CHART_PATH}/values.yaml
                                
                                if git diff --staged --quiet; then
                                    echo "No changes to commit"
                                else
                                    git commit -m "CI: Update Django app image tag to ${BUILD_NUMBER} [skip ci]"
                                    git push origin ${GIT_BRANCH}
                                    echo "✅ Successfully pushed changes to ${GIT_BRANCH}"
                                fi
                            """
                        }
                    } catch (Exception e) {
                        echo "Credentials not configured, using basic git push..."
                        sh """
                            git config user.name "Jenkins CI"
                            git config user.email "jenkins@goit-devops.local"
                            
                            git add ${HELM_CHART_PATH}/values.yaml
                            
                            if git diff --staged --quiet; then
                                echo "No changes to commit"
                            else
                                git commit -m "CI: Update Django app image tag to ${BUILD_NUMBER} [skip ci]"
                                git push origin ${GIT_BRANCH}
                                echo "✅ Successfully pushed changes to ${GIT_BRANCH}"
                            fi
                        """
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo "Pipeline succeeded!"
            echo "Image: ${ECR_REPOSITORY_URL}:${BUILD_NUMBER}"
            echo "Image (latest): ${ECR_REPOSITORY_URL}:latest"
            echo "Updated Helm chart: ${HELM_CHART_PATH}/values.yaml"
        }
        failure {
            echo "Pipeline failed!"
            currentBuild.result = 'FAILURE'
        }
        always {
            echo "Pipeline completed with status: ${currentBuild.result}"
        }
    }
}

